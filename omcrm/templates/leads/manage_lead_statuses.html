{% extends "layout.html" %}

{% block head_extra %}
<style>
.color-box {
    display: inline-block;
    width: 25px;
    height: 25px;
    border-radius: 5px;
    margin-right: 8px;
}
</style>
<script>
// Apply colors to boxes after page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.color-box[data-color]').forEach(function(box) {
        box.style.backgroundColor = box.getAttribute('data-color');
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Manage Client/Lead Statuses</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStatusModal">
                            <i class="fas fa-plus"></i> Add New Status
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p>Configure the statuses that clients and leads can have, such as "N/A", "Voicemail", "Contacted", etc. These statuses will appear in dropdown filters and the sidebar.</p>
                    
                    {% if statuses %}
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Status Name</th>
                                <th>Description</th>
                                <th>Display Color</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody">
                            {% for status in statuses %}
                            <tr data-status-id="{{ status.id }}">
                                <td>{{ status.status_name }}</td>
                                <td>{{ status.description or 'No description' }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="color-box" data-color="{{ status.color or '#4361ee' }}"></div>
                                        <span>{{ status.color or '#4361ee' }}</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('leads.edit_lead_status', status_id=status.id) }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <a href="{{ url_for('leads.delete_lead_status', status_id=status.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete status: {{ status.status_name }}?');">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">
                        No client/lead statuses defined yet. Add your first status to get started.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Status Modal -->
<div class="modal fade" id="addStatusModal" tabindex="-1" aria-labelledby="addStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStatusModalLabel">Add New Client/Lead Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('leads.manage_lead_statuses') }}">
                {{ form.csrf_token }}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="status_name" class="form-label">Status Name</label>
                        <input type="text" class="form-control" id="status_name" name="status_name" required 
                               placeholder="e.g. N/A, Voicemail, Contacted, Qualified">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                 placeholder="Explain when this status should be used"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="color" class="form-label">Display Color</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color" id="color" name="color" value="#4361ee">
                            <input type="text" class="form-control" id="colorHex" value="#4361ee" readonly>
                        </div>
                        <small class="text-muted">Color is used for visual identification only</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStatusModalLabel">Edit Client/Lead Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editStatusForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_status_name" class="form-label">Status Name</label>
                        <input type="text" class="form-control" id="edit_status_name" name="status_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_color" class="form-label">Display Color</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color" id="edit_color" name="color" value="#4361ee">
                            <input type="text" class="form-control" id="editColorHex" value="#4361ee" readonly>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitEditForm">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Status Modal -->
<div class="modal fade" id="deleteStatusModal" tabindex="-1" aria-labelledby="deleteStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteStatusModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="deleteStatusForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-body">
                    <p>Are you sure you want to delete the status "<span id="deleteStatusNameDisplay"></span>"?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Warning: This action cannot be undone. You can only delete statuses that are not in use.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="submitDeleteForm">Delete Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to handle editing a status
    function editStatus(form, statusId, statusName, statusDescription, statusColor) {
        console.log("Edit status called for:", statusId, statusName);
        
        // Open the edit modal and populate with data
        document.getElementById('edit_status_name').value = statusName;
        document.getElementById('edit_description').value = statusDescription;
        document.getElementById('edit_color').value = statusColor;
        document.getElementById('editColorHex').value = statusColor;
        
        // Set the form action
        document.getElementById('editStatusForm').action = "{{ url_for('leads.edit_lead_status', status_id=0) }}".replace('0', statusId);
        
        // Show the modal
        if (typeof bootstrap !== 'undefined') {
            var modal = new bootstrap.Modal(document.getElementById('editStatusModal'));
            modal.show();
        } else if (typeof $ !== 'undefined') {
            $('#editStatusModal').modal('show');
        } else {
            var modal = document.getElementById('editStatusModal');
            modal.style.display = 'block';
            modal.classList.add('show');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded");
        
        // Add debug for Bootstrap
        console.log("Bootstrap available:", typeof bootstrap !== 'undefined');
        console.log("jQuery available:", typeof $ !== 'undefined');
        
        // Remove previous event handlers since we're now using direct form submission
        
        // Sync color picker with hex value displays
        document.getElementById('color').addEventListener('input', function() {
            document.getElementById('colorHex').value = this.value;
        });
        
        document.getElementById('edit_color').addEventListener('input', function() {
            document.getElementById('editColorHex').value = this.value;
        });
        
        // Apply colors to boxes
        document.querySelectorAll('.color-box[data-color]').forEach(function(box) {
            box.style.backgroundColor = box.getAttribute('data-color');
        });
    });
</script>
{% endblock %} 