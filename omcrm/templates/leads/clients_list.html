{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 class="h4">{% if title %}{{title}}{% else %}Clients View{% endif %}</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-primary me-2 dropdown-toggle bulk_assign disabled"
                    type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <span data-feather="settings"></span> Bulk Actions
            </button>
            <div class="dropdown-menu dd-sm" aria-labelledby="dropdownMenuButton">
                {% if current_user.is_admin %}
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#leadOwnerAssignModal">Assign Owner</a>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#leadStatusAssignModal">Assign Status</a>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#leadTeamShuffleModal">Shuffle Among Team</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#leadsDeleteModal" href="#">Delete</a>
                <div class="dropdown-divider"></div>
                {% endif %}
                <a class="dropdown-item" id="export_clients_to_csv" href="#">Export to CSV</a>
            </div>
        </div>
    </div>
</div>

<!-- Filters section styled to match leads view -->
<div class="filters mb-3 border rounded p-3 bg-light">
    <h5 class="mb-3">Filters</h5>
    <form method="GET" action="{{ url_for('leads.get_clients_view') }}">
        <div class="row align-items-end">
            <div class="col-md-3 mb-2">
                <label class="form-label">Search</label>
                <input type="text" name="q" value="{{ request.args.get('q', '') }}" class="form-control" placeholder="Search clients...">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label">Lead Source</label>
                <select name="lead_source" class="form-control">
                    <option value="">-- Any Source --</option>
                    {% for source in sources if sources %}
                        <option value="{{ source.id }}" {% if request.args.get('lead_source') == source.id|string %}selected{% endif %}>{{ source.source_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-control">
                    <option value="">-- Any Status --</option>
                    {% for status in statuses if statuses %}
                        <option value="{{ status.id }}" {% if request.args.get('status') == status.id|string %}selected{% endif %}>{{ status.status_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label">Owner</label>
                <select name="owner" class="form-control">
                    <option value="">-- Select Owner --</option>
                    {% for user in users if users %}
                        <option value="{{ user.id }}" {% if request.args.get('owner') == user.id|string %}selected{% endif %}>{{ user.first_name }} {{ user.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="filter" class="me-1" style="width: 16px; height: 16px;"></i> Filter
                    </button>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <div class="d-grid">
                    <a href="{{ url_for('leads.get_clients_view') }}" class="btn btn-outline-secondary">
                        <i data-feather="refresh-cw" style="width: 16px; height: 16px;" class="me-1"></i> Reset
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Hidden inputs for bulk operations -->
<input type="hidden" class="leads_data" name="leads_data">
<input type="hidden" class="leads_owner" name="leads_owner">
<input type="hidden" class="leads_status" name="leads_status">
<input type="hidden" class="leads_to_delete" name="leads_to_delete">
<input type="hidden" class="leads_to_shuffle" name="leads_to_shuffle">

{% if leads|length > 0 %}
    <div class="table-responsive">
        <table class="table table-hover border">
            <thead class="table-light">
                <tr>
                    <th width="40" scope="col">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="select_all" value="all" />
                        </div>
                    </th>
                    <th width="100" scope="col">Actions</th>
                    <th width="150" scope="col">First Name</th>
                    <th width="150" scope="col">Last Name</th>
                    <th width="200" scope="col">Status</th>
                    <th width="220" scope="col">Email</th>
                    <th width="120" scope="col">Online Status</th>
                    <th width="150" scope="col">Phone</th>
                    <th width="150" scope="col">Country</th>
                    <th width="140" scope="col">Affiliate</th>
                    <th width="140" scope="col">Funnel</th>
                    <th width="180" scope="col">Owner</th>
                    <th width="180" scope="col">Available to Trade</th>
                    <th width="180" scope="col">Conversion Date</th>
                </tr>
            </thead>
            <tbody>
                {% for client in leads %}
                <tr>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input cb" type="checkbox" value="{{ client.id }}" />
                        </div>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('leads.update_lead', lead_id=client.id) }}"
                               class="btn btn-sm btn-outline-primary" title="Edit">
                                <i data-feather="edit" class="icon-sm"></i>
                            </a>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#singleClientDeleteModal_{{ client.id }}"
                               class="btn btn-sm btn-outline-danger" title="Delete">
                                <i data-feather="trash-2" class="icon-sm"></i>
                            </a>
                            <a href="{{ url_for('leads.get_lead_view', lead_id=client.id) }}"
                               class="btn btn-sm btn-outline-info" title="View">
                                <i data-feather="eye" class="icon-sm"></i>
                            </a>
                            <form method="POST" action="{{ url_for('leads.login_as_client', client_id=client.id) }}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Login as Client to WebTrader">
                                    <i data-feather="log-in" class="icon-sm"></i>
                                </button>
                            </form>
                        </div>
                        {% with lead_id=client.id %}
                            {% include 'leads/single_lead_delete_modal.html' %}
                        {% endwith %}
                    </td>
                    <td>{{ client.first_name }}</td>
                    <td>{{ client.last_name }}</td>
                    <td>
                        <select class="form-select form-select-sm lead-status-select" style="min-width: 140px;" data-lead-id="{{ client.id }}">
                            <option value="" {% if not client.lead_status_id %}selected{% endif %}>No Status</option>
                            {% for status in statuses %}
                                <option value="{{ status.id }}" {% if client.lead_status_id == status.id %}selected{% endif %}>
                                    {{ status.status_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        {% if client.email %}
                            <a href="mailto:{{ client.email }}" class="text-decoration-none">
                                <i data-feather="mail" class="icon-sm text-primary me-1"></i> {{ client.email }}
                            </a>
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-{{ client.online_status_color }} me-2">
                                {% if client.is_online %}
                                    <i data-feather="circle" class="icon-sm"></i> Online
                                {% else %}
                                    <i data-feather="clock" class="icon-sm"></i> {{ client.last_seen_formatted }}
                                {% endif %}
                            </span>
                        </div>
                        {% if client.last_login_at %}
                            <small class="text-muted d-block">
                                <i data-feather="log-in" class="icon-xs me-1"></i>
                                {{ client.login_count }} login{{ 's' if client.login_count != 1 else '' }}
                            </small>
                        {% endif %}
                    </td>
                    <td>
                        {% if client.phone %}
                            <a href="tel:{{ client.phone }}" class="text-decoration-none">
                                <i data-feather="phone" class="icon-sm text-primary me-1"></i> {{ client.phone }}
                            </a>
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if client.country %}
                            {% set country_code = client.country|lower|replace(' ', '') %}
                            {% if country_code == 'unitedstates' %}{% set country_code = 'us' %}
                            {% elif country_code == 'unitedkingdom' %}{% set country_code = 'gb' %}
                            {% elif country_code == 'japan' %}{% set country_code = 'jp' %}
                            {% elif country_code == 'china' %}{% set country_code = 'cn' %}
                            {% elif country_code == 'india' %}{% set country_code = 'in' %}
                            {% elif country_code == 'brazil' %}{% set country_code = 'br' %}
                            {% elif country_code == 'russia' %}{% set country_code = 'ru' %}
                            {% elif country_code == 'germany' %}{% set country_code = 'de' %}
                            {% elif country_code == 'france' %}{% set country_code = 'fr' %}
                            {% elif country_code == 'spain' %}{% set country_code = 'es' %}
                            {% elif country_code == 'italy' %}{% set country_code = 'it' %}
                            {% elif country_code == 'canada' %}{% set country_code = 'ca' %}
                            {% elif country_code == 'australia' %}{% set country_code = 'au' %}
                            {% endif %}
                            <img src="https://flagcdn.com/24x18/{{ country_code }}.png" alt="{{ client.country }}" class="country-flag"> {{ client.country }}
                        {% else %}
                            <span class="text-muted">Not provided</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if client.affiliate_id %}
                            <span class="badge bg-success">{{ client.affiliate_id }}</span>
                        {% elif client.source and client.source.affiliate_id %}
                            <span class="badge bg-secondary">{{ client.source.affiliate_id }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if client.funnel_name %}
                            <span class="badge bg-primary">{{ client.funnel_name }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{% with owner=client.owner %}{% include 'common/owner_cell.html' %}{% endwith %}</td>
                    <td>
                        {% if client.available_to_trade %}
                            <span class="badge bg-success trade-status-badge" data-client-id="{{ client.id }}" data-status="true" style="cursor: pointer;">Yes</span>
                        {% else %}
                            <span class="badge bg-danger trade-status-badge" data-client-id="{{ client.id }}" data-status="false" style="cursor: pointer;">No</span>
                        {% endif %}
                    </td>
                    <td>{{ client.conversion_date.strftime('%Y-%m-%d') if client.conversion_date }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- pagination -->
    {% if total_leads > 10 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if paginator.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('leads.get_clients_view', page=paginator.prev_num) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo;</span>
                </li>
                {% endif %}
                
                {% for page_num in paginator.iter_pages() %}
                    {% if page_num %}
                        {% if page_num == paginator.page %}
                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                        {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('leads.get_clients_view', page=page_num) }}">{{ page_num }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                
                {% if paginator.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('leads.get_clients_view', page=paginator.next_num) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
{% else %}
    <div class="empty-state">
        <div><span data-feather="eye-off"></span></div>
        <p>No clients found.</p>
    </div>
{%  endif %}

<script>
    $(document).ready(function() {
        var selectedItems = [];
        
        // Handle select all checkbox
        $('#select_all').change(function() {
            if ($(this).prop('checked')) {
                $('.cb').prop('checked', true);
                $('.bulk_assign').removeClass('disabled');
                // Get all values of checkboxes
                selectedItems = $('.cb:checked').map(function() {
                    return $(this).val();
                }).get();
            } else {
                $('.cb').prop('checked', false);
                $('.bulk_assign').addClass('disabled');
                selectedItems = [];
            }
            // Update all hidden fields with the selected items
            $('.leads_data').val(selectedItems.join(','));
            console.log('Selected clients:', selectedItems);
        });
        
        // Handle individual checkboxes
        $('.cb').change(function() {
            // Get all values of checkboxes that are checked
            selectedItems = $('.cb:checked').map(function() {
                return $(this).val();
            }).get();
            
            // If there are checked items, enable the bulk assign button
            if (selectedItems.length > 0) {
                $('.bulk_assign').removeClass('disabled');
            } else {
                $('.bulk_assign').addClass('disabled');
            }
            
            // Update select_all checkbox state
            if ($('.cb:checked').length === $('.cb').length) {
                $('#select_all').prop('checked', true);
            } else {
                $('#select_all').prop('checked', false);
            }
            
            // Update all hidden fields with the selected items
            $('.leads_data').val(selectedItems.join(','));
            console.log('Selected clients:', selectedItems);
        });
        
        // Init select2 for status selects if available
        if ($.fn.select2) {
            $('.lead-status-select').select2({
                theme: 'bootstrap4',
                minimumResultsForSearch: -1,
                width: '100%'
            });
        }
        
        // Update client status via AJAX when changed
        $('.lead-status-select').change(function(e) {
            e.preventDefault(); // Prevent any default form submission
            e.stopPropagation(); // Prevent event bubbling
            
            const $select = $(this);
            const leadId = $select.data('lead-id');
            const statusId = $select.val();
            const previousValue = $select.data('previous-value') || '';
            
            // Store current value as previous for next time
            $select.data('previous-value', statusId);
            
            console.log('Updating client status:', { leadId, statusId, previousValue });
            
            $.ajax({
                url: '/leads/update_status',
                type: 'POST',
                data: {
                    lead_id: leadId,
                    status_id: statusId || '',  // Send empty string for "No Status"
                    csrf_token: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('Status update response:', response);
                    if (response.success) {
                        // Show success message
                        toastr.success('Client status updated successfully');
                        // Update the selected attribute in the DOM
                        $select.find('option').removeAttr('selected');
                        if (statusId) {
                            $select.find('option[value="' + statusId + '"]').attr('selected', 'selected');
                        } else {
                            $select.find('option[value=""]').attr('selected', 'selected');
                        }
                    } else {
                        // Show error message
                        toastr.error(response.message || 'Error updating client status');
                        // Reset select to previous value
                        $select.val(previousValue);
                        $select.data('previous-value', previousValue);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', { xhr, status, error });
                    // Show error message
                    toastr.error('Error updating client status: ' + (xhr.responseJSON?.message || error));
                    // Reset select to previous value
                    $select.val(previousValue);
                    $select.data('previous-value', previousValue);
                }
            });
        });
        
        // Prepare modal data when bulk actions are clicked
        $('.dropdown-item').click(function() {
            // Only run for modal triggers that are related to bulk actions
            if ($(this).attr('data-bs-toggle') === 'modal') {
                // Get the target modal ID
                const modalId = $(this).attr('data-bs-target');
                console.log('Modal triggered:', modalId);
                
                // Get selected item values
                console.log('Selected client IDs:', selectedItems);
                
                // Map actual modal IDs to the appropriate hidden input fields
                if (modalId === '#leadOwnerAssignModal') {
                    $('.leads_owner').val(selectedItems.join(','));
                } else if (modalId === '#leadStatusAssignModal') {
                    $('.leads_status').val(selectedItems.join(','));
                } else if (modalId === '#leadTeamShuffleModal') {
                    $('.leads_to_shuffle').val(selectedItems.join(','));
                } else if (modalId === '#leadsDeleteModal') {
                    $('.leads_to_delete').val(selectedItems.join(','));
                }
                
                // Update the general leads_data field as a fallback
                $('.leads_data').val(selectedItems.join(','));
                
                // Show notification in the modal with selection count
                $(modalId).find('.modal-notif-area').html(`
                    <div class="alert alert-info" role="alert">
                        You have selected <strong>${selectedItems.length}</strong> clients for this action.
                    </div>`);
            }
        });
        
        // CSV Export
        $('#export_clients_to_csv').click(function(e) {
            e.preventDefault();
            let url = '{{ url_for("leads.export_clients_csv") }}';
            
            // If we have selected items, add them as a query parameter
            if (selectedItems.length > 0) {
                url += '?ids=' + selectedItems.join(',');
            }
            
            // Open in a new tab
            window.open(url, '_blank');
        });
        
        // Toggle Available to Trade status
        $(document).on('click', '.trade-status-badge', function() {
            const clientId = $(this).data('client-id');
            const currentStatus = $(this).data('status');
            const newStatus = !currentStatus;
            const badge = $(this);
            
            $.ajax({
                url: "{{ url_for('leads.toggle_trade_status') }}",
                type: "POST",
                data: {
                    client_id: clientId,
                    status: newStatus.toString()
                },
                success: function(response) {
                    if (response.success) {
                        if (newStatus) {
                            badge.removeClass('bg-danger').addClass('bg-success');
                            badge.text('Yes');
                            badge.data('status', true);
                        } else {
                            badge.removeClass('bg-success').addClass('bg-danger');
                            badge.text('No');
                            badge.data('status', false);
                        }
                        toastr.success(response.message);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'An error occurred. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    toastr.error(errorMessage);
                }
            });
        });
    });
</script>

<style>
    /* Custom styling for status dropdowns */
    .lead-status-select {
        width: 100%;
        min-width: 140px !important;
        max-width: 100%;
        appearance: revert;
        -webkit-appearance: menulist;
        padding-right: 20px;
        background-color: #fff;
    }
    
    /* Make sure dropdown options are visible when open */
    select.lead-status-select option {
        background-color: white;
        color: #333;
        padding: 3px;
    }
    
    /* Add responsive behavior */
    @media (max-width: 768px) {
        .lead-status-select {
            min-width: 100px !important;
        }
    }
</style>

<!-- Client Owner Assign Modal -->
{% include "leads/bulk_owner_assign_modal.html" %}

<!-- Client Bulk Delete Modal -->
{% include "leads/bulk_lead_delete_modal.html" %}

<!-- Lead Team Shuffle Modal -->
{% include "leads/lead_team_shuffle_modal.html" %}

<!-- Lead Status Assignment Modal -->
{% include "leads/bulk_lead_status_assign_modal.html" %}

{% endblock %}
