{% extends "client_layout.html" %}
{% block content %}
<!-- Modern, clean analytics interface -->
<div class="container-fluid px-0">
    <!-- Minimal header -->
    <div class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
        <h1 class="fs-4 fw-normal m-0">Trading Performance</h1>
        <div>
            <a href="{{ url_for('client.dashboard') }}" class="btn btn-sm btn-light me-2">
                <i data-feather="arrow-left" class="me-1" style="width: 16px; height: 16px;"></i>Dashboard
            </a>
            <a href="{{ url_for('webtrader.webtrader_dashboard') }}" class="btn btn-sm btn-primary">
                <i data-feather="trending-up" class="me-1" style="width: 16px; height: 16px;"></i>WebTrader
            </a>
        </div>
    </div>

    <!-- Key metrics cards in a single row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Win Rate</small>
                        <h2 class="fs-1 mb-0 {{ 'text-success' if metrics.win_rate >= 50 else '' }}">{{ "%.1f"|format(metrics.win_rate) }}%</h2>
                        <small class="text-muted">{{ metrics.winning_trades }} of {{ metrics.total_trades }} trades</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Total P/L</small>
                        <h2 class="fs-1 mb-0 {{ 'text-success' if metrics.total_pnl > 0 else 'text-danger' if metrics.total_pnl < 0 else '' }}">
                            ${{ "%.2f"|format(metrics.total_pnl) }}
                        </h2>
                        <small class="text-muted">All time</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Avg. Profit</small>
                        <h2 class="fs-1 mb-0 text-success">${{ "%.2f"|format(metrics.avg_profit_per_winning_trade) }}</h2>
                        <small class="text-muted">Per winning trade</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Avg. Loss</small>
                        <h2 class="fs-1 mb-0 text-danger">${{ "%.2f"|format(metrics.avg_loss_per_losing_trade) }}</h2>
                        <small class="text-muted">Per losing trade</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section - MODERN & WORKING -->
    <div class="row g-4 mb-4">
        
        <!-- Chart 1: Cumulative P/L -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0" style="background: white;">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Cumulative P/L</h5>
                    <div id="cumulativePLChart" style="width: 400px; height: 250px; margin: 0 auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- Chart 2: Monthly Performance -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0" style="background: white;">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Monthly Performance</h5>
                    <div id="monthlyPerformanceChart" style="width: 400px; height: 250px; margin: 0 auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- Chart 3: Performance by Instrument -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0" style="background: white;">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Performance by Instrument</h5>
                    <div id="instrumentPerformanceChart" style="width: 400px; height: 250px; margin: 0 auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- Chart 4: Win/Loss Distribution -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0" style="background: white;">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Win/Loss Distribution</h5>
                    <div id="winLossDistributionChart" style="width: 400px; height: 250px; margin: 0 auto;"></div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Trade Journal -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title text-muted mb-0">Trade Journal</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showClosedTradesOnly">
                    <label class="form-check-label small text-muted" for="showClosedTradesOnly">Show closed trades only</label>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Instrument</th>
                            <th>Type</th>
                            <th>Entry Price</th>
                            <th>Exit Price</th>
                            <th>Amount</th>
                            <th>P/L</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in trades %}
                        <tr class="trade-row {{ 'closed-trade' if trade.status == 'closed' else 'open-trade' }}">
                            <td>{{ trade.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ trade.instrument.symbol if trade.instrument else 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if trade.trade_type == 'buy' else 'danger' }}">
                                    {{ trade.trade_type.upper() }}
                                </span>
                            </td>
                            <td>${{ "%.4f"|format(trade.price) }}</td>
                            <td>
                                {% if trade.closing_price %}
                                    ${{ "%.4f"|format(trade.closing_price) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ trade.amount }}</td>
                            <td>
                                {% if trade.status == 'closed' and trade.profit_loss %}
                                    <span class="badge bg-{{ 'success' if trade.profit_loss > 0 else 'danger' }}">
                                        ${{ "%.2f"|format(trade.profit_loss) }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'primary' if trade.status == 'open' else 'secondary' }}">
                                    {{ trade.status|capitalize }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('client.view_trade_details', trade_id=trade.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i data-feather="eye" style="width: 14px; height: 14px;"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>

<!-- Embed chart data as separate script tags to avoid syntax errors -->
<script id="chartDataScript">
window.analyticsData = {
    cumulative: {{ cumulative_pl_data | tojson | safe }},
    monthly: {{ monthly_performance_data | tojson | safe }},
    instrument: {{ instrument_performance_data | tojson | safe }},
    winLoss: {{ win_loss_distribution_data | tojson | safe }}
};
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Starting FIXED chart creation...');
    
    setTimeout(function() {
        if (typeof Plotly !== 'undefined') {
            console.log('✅ Plotly loaded');
            console.log('📊 Chart data available:', typeof window.analyticsData);
            
            // Create real charts immediately
            createRealCharts();
            
        } else {
            console.error('❌ Plotly not loaded');
        }
    }, 1000);
});

function createRealCharts() {
    console.log('🔄 Creating real charts...');
    
    // Create all four charts with FORCED DIMENSIONS
    if (window.analyticsData) {
        
        // 1. Cumulative P/L Chart
        if (window.analyticsData.cumulative) {
            try {
                var data = window.analyticsData.cumulative;
                if (data.data && data.layout) {
                    // FORCE DIMENSIONS
                    data.layout.width = 400;
                    data.layout.height = 250;
                    
                    Plotly.newPlot('cumulativePLChart', data.data, data.layout, {responsive: false, displayModeBar: false});
                    console.log('✅ Real cumulative chart created with forced dimensions');
                }
            } catch (error) {
                console.error('❌ Cumulative chart error:', error);
            }
        }
        
        // 2. Monthly Performance Chart
        if (window.analyticsData.monthly) {
            try {
                var data = window.analyticsData.monthly;
                if (data.data && data.layout) {
                    // FORCE DIMENSIONS
                    data.layout.width = 400;
                    data.layout.height = 250;
                    
                    Plotly.newPlot('monthlyPerformanceChart', data.data, data.layout, {responsive: false, displayModeBar: false});
                    console.log('✅ Real monthly chart created with forced dimensions');
                }
            } catch (error) {
                console.error('❌ Monthly chart error:', error);
            }
        }
        
        // 3. Instrument Performance Chart
        if (window.analyticsData.instrument) {
            try {
                var data = window.analyticsData.instrument;
                if (data.data && data.layout) {
                    // FORCE DIMENSIONS
                    data.layout.width = 400;
                    data.layout.height = 250;
                    
                    Plotly.newPlot('instrumentPerformanceChart', data.data, data.layout, {responsive: false, displayModeBar: false});
                    console.log('✅ Real instrument chart created with forced dimensions');
                }
            } catch (error) {
                console.error('❌ Instrument chart error:', error);
            }
        }
        
        // 4. Win/Loss Distribution Chart
        if (window.analyticsData.winLoss) {
            try {
                var data = window.analyticsData.winLoss;
                if (data.data && data.layout) {
                    // FORCE DIMENSIONS
                    data.layout.width = 400;
                    data.layout.height = 250;
                    
                    Plotly.newPlot('winLossDistributionChart', data.data, data.layout, {responsive: false, displayModeBar: false});
                    console.log('✅ Real win/loss chart created with forced dimensions');
                }
            } catch (error) {
                console.error('❌ Win/loss chart error:', error);
            }
        }
        
    } else {
        console.error('❌ No chart data available');
    }
}
</script>
{% endblock scripts %} 