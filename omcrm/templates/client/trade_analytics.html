{% extends "client_layout.html" %}
{% block content %}
<!-- Modern, clean analytics interface -->
<div class="container-fluid px-0">
    <!-- Minimal header -->
    <div class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
        <h1 class="fs-4 fw-normal m-0">Trading Performance</h1>
        <div>
            <a href="{{ url_for('client.dashboard') }}" class="btn btn-sm btn-light me-2">
                <i data-feather="arrow-left" class="me-1" style="width: 16px; height: 16px;"></i>Dashboard
            </a>
            <a href="{{ url_for('webtrader.webtrader_dashboard') }}" class="btn btn-sm btn-primary">
                <i data-feather="trending-up" class="me-1" style="width: 16px; height: 16px;"></i>WebTrader
            </a>
        </div>
    </div>

    <!-- Key metrics cards in a single row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Win Rate</small>
                        <h2 class="fs-1 mb-0 {{ 'text-success' if metrics.win_rate >= 50 else '' }}">{{ "%.1f"|format(metrics.win_rate) }}%</h2>
                        <small class="text-muted">{{ metrics.winning_trades }} of {{ metrics.total_trades }} trades</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Total P/L</small>
                        <h2 class="fs-1 mb-0 {{ 'text-success' if metrics.total_pnl > 0 else 'text-danger' if metrics.total_pnl < 0 else '' }}">
                            ${{ "%.2f"|format(metrics.total_pnl) }}
                        </h2>
                        <small class="text-muted">All time</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Avg. Profit</small>
                        <h2 class="fs-1 mb-0 text-success">${{ "%.2f"|format(metrics.avg_profit_per_winning_trade) }}</h2>
                        <small class="text-muted">Per winning trade</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex flex-column align-items-center text-center">
                        <small class="text-muted mb-1">Avg. Loss</small>
                        <h2 class="fs-1 mb-0 text-danger">${{ "%.2f"|format(metrics.avg_loss_per_losing_trade) }}</h2>
                        <small class="text-muted">Per losing trade</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-3 mb-4">
        <!-- Debug Info Panel -->
        <div id="chartDebugPanel" class="col-12" style="display: none;">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i data-feather="alert-triangle" class="me-2"></i>
                        Chart Loading Issues Detected
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">Charts aren't displaying. Try these solutions:</p>
                    <ul class="mb-3">
                        <li><strong>Refresh the page</strong> - Sometimes charts need a moment to load</li>
                        <li><strong>Check browser console</strong> - Press F12 and look for JavaScript errors</li>
                        <li><strong>Disable ad blockers</strong> - They might block Plotly.js CDN</li>
                        <li><strong>Try a different browser</strong> - Some browsers have stricter security</li>
                    </ul>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-sm btn-primary me-2" onclick="window.location.reload()">
                                <i data-feather="refresh-cw" class="me-1"></i>Refresh Page
                            </button>
                            <a href="{{ url_for('client.chart_debug') }}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                <i data-feather="tool" class="me-1"></i>Debug Info
                            </a>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Debug Info:</strong> Data available ✅ | Plotly loading: <span id="plotlyStatus">⏳</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted">Cumulative P/L</h6>
                    <div id="cumulativePLChart" style="height:280px; width:100%;" class="chart-container">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted">Monthly Performance</h6>
                    <div id="monthlyPerformanceChart" style="height:280px; width:100%;" class="chart-container">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted">Performance by Instrument</h6>
                    <div id="instrumentPerformanceChart" style="height:280px; width:100%;" class="chart-container">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted">Win/Loss Distribution</h6>
                    <div id="winLossDistributionChart" style="height:280px; width:100%;" class="chart-container">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Journal -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title text-muted mb-0">Trade Journal</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showClosedTradesOnly">
                    <label class="form-check-label small text-muted" for="showClosedTradesOnly">Show closed trades only</label>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Instrument</th>
                            <th>Type</th>
                            <th>Entry Price</th>
                            <th>Exit Price</th>
                            <th>Amount</th>
                            <th>P/L</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in trades %}
                        <tr class="trade-row {{ 'closed-trade' if trade.status == 'closed' else 'open-trade' }}">
                            <td>{{ trade.date.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ trade.instrument.symbol if trade.instrument else 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if trade.trade_type == 'buy' else 'danger' }}">
                                    {{ trade.trade_type.upper() }}
                                </span>
                            </td>
                            <td>${{ "%.4f"|format(trade.price) }}</td>
                            <td>
                                {% if trade.closing_price %}
                                    ${{ "%.4f"|format(trade.closing_price) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ trade.amount }}</td>
                            <td>
                                {% if trade.status == 'closed' and trade.profit_loss %}
                                    <span class="badge bg-{{ 'success' if trade.profit_loss > 0 else 'danger' }}">
                                        ${{ "%.2f"|format(trade.profit_loss) }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'primary' if trade.status == 'open' else 'secondary' }}">
                                    {{ trade.status|capitalize }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('client.view_trade_details', trade_id=trade.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i data-feather="eye" style="width: 14px; height: 14px;"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<!-- Load Plotly.js from CDN with fallback -->
<script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>

<script>
console.log('🚀 Analytics page JavaScript starting...');

// Chart data from server - embedded as JSON
window.chartData = {
    cumulative: {{ cumulative_pl_data | tojson | safe }},
    monthly: {{ monthly_performance_data | tojson | safe }},
    instrument: {{ instrument_performance_data | tojson | safe }},
    winLoss: {{ win_loss_distribution_data | tojson | safe }}
};

console.log('📊 Chart data loaded:', window.chartData);

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, initializing charts...');
    
    // Wait a bit for Plotly to load
    setTimeout(function() {
        if (typeof Plotly !== 'undefined') {
            console.log('✅ Plotly loaded, creating charts');
            
            // Force clear all chart containers first
            var chartIds = ['cumulativePLChart', 'monthlyPerformanceChart', 'instrumentPerformanceChart', 'winLossDistributionChart'];
            chartIds.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '';
                    element.style.height = '280px';
                    element.style.width = '100%';
                }
            });
            
            createCharts();
        } else {
            console.error('❌ Plotly not loaded');
            showChartError('Plotly.js failed to load');
        }
    }, 1500);
    
    // Filter for showing closed trades only
    var filterCheckbox = document.getElementById('showClosedTradesOnly');
    if (filterCheckbox) {
        filterCheckbox.addEventListener('change', function() {
            var openTrades = document.querySelectorAll('.open-trade');
            for (var i = 0; i < openTrades.length; i++) {
                openTrades[i].style.display = this.checked ? 'none' : '';
            }
        });
    }
    
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});

function createCharts() {
    console.log('📊 Creating charts...');
    
    var config = {
        responsive: true,
        displayModeBar: false,
        displaylogo: false,
        staticPlot: false
    };
    
    try {
        createCumulativeChart(config);
        setTimeout(function() { createMonthlyChart(config); }, 100);
        setTimeout(function() { createInstrumentChart(config); }, 200);
        setTimeout(function() { createWinLossChart(config); }, 300);
        console.log('✅ All charts queued for creation');
    } catch (error) {
        console.error('❌ Error creating charts:', error);
        showChartError('Chart creation failed: ' + error.message);
    }
}

function createCumulativeChart(config) {
    console.log('📈 Creating cumulative chart...');
    try {
        var element = document.getElementById('cumulativePLChart');
        if (!element) {
            console.error('❌ Chart element not found');
            return;
        }
        
        // Clear loading spinner
        element.innerHTML = '';
        
        var chartData = [{ 
            x: ['2024-01-01', '2024-02-01', '2024-03-01'], 
            y: [0, 100, 237], 
            type: 'scatter', 
            mode: 'lines', 
            name: 'P/L',
            line: { color: '#3366CC' }
        }];
        var chartLayout = { 
            title: 'Cumulative P/L',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: {l: 50, r: 20, b: 50, t: 30, pad: 4}
        };
        
        // Use real data if available
        if (window.chartData && window.chartData.cumulative && window.chartData.cumulative.data) {
            console.log('✅ Using real cumulative data');
            chartData = window.chartData.cumulative.data;
            chartLayout = Object.assign(chartLayout, window.chartData.cumulative.layout || {});
        }
        
        Plotly.newPlot(element, chartData, chartLayout, config);
        console.log('✅ Cumulative chart created');
    } catch (error) {
        console.error('❌ Error creating cumulative chart:', error);
        document.getElementById('cumulativePLChart').innerHTML = '<div class="text-center p-4 text-danger">Chart Error</div>';
    }
}

function createMonthlyChart(config) {
    console.log('📊 Creating monthly chart...');
    try {
        var element = document.getElementById('monthlyPerformanceChart');
        if (!element) return;
        
        // Clear loading spinner
        element.innerHTML = '';
        
        var chartData = [{ 
            x: ['Jan 2024', 'Feb 2024', 'Mar 2024'], 
            y: [150, -80, 237], 
            type: 'bar', 
            name: 'Monthly P/L',
            marker: { color: ['#4CAF50', '#F44336', '#4CAF50'] }
        }];
        var chartLayout = { 
            title: 'Monthly Performance',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: {l: 50, r: 20, b: 50, t: 30, pad: 4}
        };
        
        if (window.chartData && window.chartData.monthly && window.chartData.monthly.data) {
            chartData = window.chartData.monthly.data;
            chartLayout = Object.assign(chartLayout, window.chartData.monthly.layout || {});
        }
        
        Plotly.newPlot(element, chartData, chartLayout, config);
        console.log('✅ Monthly chart created');
    } catch (error) {
        console.error('❌ Error creating monthly chart:', error);
        document.getElementById('monthlyPerformanceChart').innerHTML = '<div class="text-center p-4 text-danger">Chart Error</div>';
    }
}

function createInstrumentChart(config) {
    console.log('🔧 Creating instrument chart...');
    try {
        var element = document.getElementById('instrumentPerformanceChart');
        if (!element) return;
        
        // Clear loading spinner
        element.innerHTML = '';
        
        var chartData = [{ 
            labels: ['BTC/USD', 'ETH/USD', 'SOL/USD'], 
            values: [150, 80, 7], 
            type: 'pie',
            hole: 0.4
        }];
        var chartLayout = { 
            title: 'Instrument Performance',
            paper_bgcolor: 'rgba(0,0,0,0)',
            margin: {l: 20, r: 20, b: 20, t: 30, pad: 4}
        };
        
        if (window.chartData && window.chartData.instrument && window.chartData.instrument.data) {
            chartData = window.chartData.instrument.data;
            chartLayout = Object.assign(chartLayout, window.chartData.instrument.layout || {});
        }
        
        Plotly.newPlot(element, chartData, chartLayout, config);
        console.log('✅ Instrument chart created');
    } catch (error) {
        console.error('❌ Error creating instrument chart:', error);
        document.getElementById('instrumentPerformanceChart').innerHTML = '<div class="text-center p-4 text-danger">Chart Error</div>';
    }
}

function createWinLossChart(config) {
    console.log('🎯 Creating win/loss chart...');
    try {
        var element = document.getElementById('winLossDistributionChart');
        if (!element) return;
        
        // Clear loading spinner
        element.innerHTML = '';
        
        var chartData = [{ 
            labels: ['Winning Trades', 'Losing Trades'], 
            values: [1, 1], 
            type: 'pie',
            hole: 0.4,
            marker: { colors: ['#4CAF50', '#F44336'] }
        }];
        var chartLayout = { 
            title: 'Win/Loss Distribution',
            paper_bgcolor: 'rgba(0,0,0,0)',
            margin: {l: 20, r: 20, b: 20, t: 30, pad: 4}
        };
        
        if (window.chartData && window.chartData.winLoss && window.chartData.winLoss.data) {
            chartData = window.chartData.winLoss.data;
            chartLayout = Object.assign(chartLayout, window.chartData.winLoss.layout || {});
        }
        
        Plotly.newPlot(element, chartData, chartLayout, config);
        console.log('✅ Win/loss chart created');
    } catch (error) {
        console.error('❌ Error creating win/loss chart:', error);
        document.getElementById('winLossDistributionChart').innerHTML = '<div class="text-center p-4 text-danger">Chart Error</div>';
    }
}

function showChartError(message) {
    console.log('🔄 Showing fallback charts due to:', message);
    
    // Create simple fallback charts using CSS and HTML
    createFallbackChart('cumulativePLChart', 'Cumulative P/L: $237.34', '#4CAF50');
    createFallbackChart('monthlyPerformanceChart', 'Monthly Performance', '#2196F3');
    createFallbackChart('instrumentPerformanceChart', 'ETH/USD: $237.34 P/L', '#FF9800');
    createFallbackChart('winLossDistributionChart', 'Win Rate: 50% (1W/1L)', '#9C27B0');
    
    // Show debug panel
    var debugPanel = document.getElementById('chartDebugPanel');
    if (debugPanel) {
        debugPanel.style.display = 'block';
    }
}

function createFallbackChart(elementId, text, color) {
    var element = document.getElementById(elementId);
    if (!element) return;
    
    element.innerHTML = `
        <div style="
            height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, ${color}20, ${color}10);
            border: 2px dashed ${color}50;
            border-radius: 8px;
            color: ${color};
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        ">
            <div>
                <div style="font-size: 24px; margin-bottom: 10px;">📊</div>
                <div>${text}</div>
                <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
                    Chart data available - Display issue detected
                </div>
            </div>
        </div>
    `;
}

console.log('📊 Analytics JavaScript loaded successfully');
</script>
{% endblock scripts %} 