{% extends "layout.html" %}
{% block styles %}
<style>
    .kanban-container {
        display: flex;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    .kanban-column {
        flex: 0 0 300px;
        margin-right: 15px;
        background-color: #f8f9fa;
        border-radius: 6px;
    }
    .kanban-column-header {
        padding: 10px 15px;
        font-weight: bold;
        border-bottom: 1px solid #dee2e6;
        background-color: #e9ecef;
        border-radius: 6px 6px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .kanban-column-count {
        background-color: rgba(0,0,0,0.1);
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.8rem;
    }
    .kanban-card-list {
        min-height: 50px;
        padding: 10px;
    }
    .kanban-card {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: move;
    }
    .kanban-card:hover {
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .kanban-card-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .kanban-card-client {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 8px;
    }
    .kanban-card-price {
        font-weight: bold;
    }
    .kanban-card-date {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .kanban-card-actions {
        margin-top: 8px;
        font-size: 0.8rem;
    }
    .kanban-card-probability {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .progress {
        height: 6px;
        margin-right: 5px;
    }
    .drag-over {
        background-color: #e2f0ff;
    }
    .debug-info {
        margin: 10px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 class="h4">Pipeline Board</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a class="btn btn-sm btn-outline-primary mr-2" role="button" href="{{ url_for('deals.get_deals_view') }}">
            <span data-feather="list"></span>
            List View
        </a>
        <a class="btn btn-sm btn-outline-primary" role="button" href="{{ url_for('deals.new_deal') }}">
            <span data-feather="plus"></span>
            New Pipeline
        </a>
    </div>
</div>

{% include "deals/kanban_filters.html" %}

<div class="kanban-container">
    {% for stage in deal_stages %}
    <div class="kanban-column">
        <div class="kanban-column-header">
            {{ stage.stage_name }}
            <span class="kanban-column-count" id="count-{{ stage.id }}">
                {{ deals|selectattr('deal_stage_id', 'eq', stage.id)|list|length }}
            </span>
        </div>
        <div class="kanban-card-list" id="stage-{{ stage.id }}" data-stage-id="{{ stage.id }}">
            {% for deal in deals %}
                {% if deal.deal_stage_id == stage.id %}
                <div class="kanban-card" id="deal-{{ deal.id }}" data-deal-id="{{ deal.id }}" draggable="true">
                    <div class="kanban-card-title">{{ deal.title }}</div>
                    <div class="kanban-card-client">{{ deal.client.first_name }} {{ deal.client.last_name }}</div>
                    <div class="kanban-card-probability">
                        <div class="progress flex-grow-1">
                            {% if deal.probability < 30 %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ deal.probability }}%"></div>
                            {% elif deal.probability < 70 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ deal.probability }}%"></div>
                            {% else %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ deal.probability }}%"></div>
                            {% endif %}
                        </div>
                        <span>{{ deal.probability }}%</span>
                    </div>
                    <div class="kanban-card-price">{{ config.def_currency.symbol }} {{ "{:,.2f}".format(deal.expected_close_price) }}</div>
                    <div class="kanban-card-date">{{ deal.expected_close_date.strftime('%Y-%m-%d') if deal.expected_close_date else 'No date' }}</div>
                    <div class="kanban-card-actions">
                        <a href="/deals/{{ deal.id }}" class="btn btn-sm btn-outline-secondary">
                            <span data-feather="eye"></span>
                        </a>
                        <a href="/deals/edit/{{ deal.id }}" class="btn btn-sm btn-outline-secondary">
                            <span data-feather="edit"></span>
                        </a>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize feather icons
        feather.replace();
        
        // Add drag and drop functionality
        setupDragAndDrop();

        function setupDragAndDrop() {
            // Make cards draggable
            document.querySelectorAll('.kanban-card').forEach(function(card) {
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', card.id);
                    setTimeout(() => {
                        card.classList.add('invisible');
                    }, 0);
                });
                
                card.addEventListener('dragend', function() {
                    card.classList.remove('invisible');
                });
            });
            
            // Set up drop targets
            document.querySelectorAll('.kanban-card-list').forEach(function(column) {
                column.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                column.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                column.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const cardId = e.dataTransfer.getData('text/plain');
                    const card = document.getElementById(cardId);
                    const stageId = this.dataset.stageId;
                    const dealId = card.dataset.dealId;
                    
                    // Move the card to the new column
                    this.appendChild(card);
                    
                    // Update counts
                    updateColumnCounts();
                    
                    // Save the change via AJAX
                    fetch(`/deals/update_stage/${dealId}/${stageId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to update stage');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (!data.success) {
                                console.error('Error updating stage:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Revert the change if there was an error
                        });
                });
            });
        }
        
        // We still need this for updating counts after drag and drop
        function updateColumnCounts() {
            document.querySelectorAll('.kanban-card-list').forEach(function(column) {
                const stageId = column.dataset.stageId;
                const count = column.querySelectorAll('.kanban-card').length;
                document.getElementById(`count-${stageId}`).textContent = count;
            });
        }
    });
</script>
{% endblock %}
